# ğŸ§­ FocusTube - Chrome MV3 Extension + Backend + AI Build Plan

## Product Vision
FocusTube is a productivity-driven YouTube companion that reduces distraction and restores intentional viewing.

It has two main components:
1. **Chrome MV3 Extension** (`/extension`) â€” Monitors YouTube activity and enforces rules.
2. **Backend Server** (`/server`) â€” Handles authentication, plan management, and AI classification via Supabase + Stripe + OpenAI.

---

## Core User Flow
- User signs up (Supabase email/password)
- Chooses Free or Pro plan (via Stripe checkout)
- Downloads extension â†’ logs in
- Extension syncs plan + rules from backend
- While browsing YouTube, FocusTube monitors behavior and enforces blocking/allowance logic

---

## Plan Behavior

### Free Plan
- **Shorts:** Hard blocked instantly (redirect to YouTube home + overlay message)
- **Searches:** 5/day limit, overlay after cap
- **Reminders:** 30-min usage banners
- **AI:** None (neutral fallback always)

### Pro Plan
- **Shorts:** Allowed but tracked  
  - Live counter: â€œYouâ€™ve watched N Shorts todayâ€  
  - Every 5 Shorts â†’ popup: â€œCarry on or block for today?â€
- **Searches:** 15/day  
- **AI Filtering:**  
  - All searches/titles sent to `/ai/classify`
  - If marked *distracting* â†’ daily allowance (1 video **or** 10 minutes)
  - After allowance â†’ block distracting content for rest of day  
- **Reminders:** 30-min usage alerts remain active

---

## ğŸ—ï¸ Build Roadmap (7-Day MVP Sprint)

### âš™ï¸ Day 1 â€” Core Server Setup
- Create `/server` (Express + TypeScript)
- Endpoints: `/health`, `/license/verify`, `/ai/classify` (stub)
- Allow CORS for extension
- Background fetches plan + calls classifier (returns neutral for now)  
âœ… Server runs locally; extension logs â€œplan: freeâ€

---

### ğŸ—„ï¸ Day 2 â€” Supabase Integration
- Create `users` and `ai_logs` tables  
- `/license/verify?email=` returns `{ plan }`
- Background updates plan on boot/daily rotation  
âœ… Plan syncs with Supabase; safe fallback if offline

---

### ğŸ’³ Day 3 â€” Stripe Checkout
- `POST /stripe/create-checkout` â†’ returns Stripe URL
- Manual plan change in Supabase after payment
- Optional `/webhook/stripe` for auto plan sync  
âœ… Users can pay â†’ plan switches to Pro

---

### ğŸ§  Day 4 â€” AI Classifier v1
- `/ai/classify` calls OpenAI and caches results 24h per user/text
- Returns `{ category: "productive"|"neutral"|"distracting" }`
- On failure â†’ fallback `{ category:"neutral" }`
- Extension invokes classifier for search/watch (Pro only)  
âœ… AI classifies content safely; fallback works offline

---

### ğŸ¯ Day 5 â€” Allowance Logic
- Add `ft_allowance_videos_left` or `ft_allowance_seconds_left`
- If â€œdistractingâ€ and allowance empty â†’ block; else decrement  
âœ… Daily distraction cap working for Pro users

---

### ğŸ’… Day 6 â€” UI & Overlay Polish
- Add counter overlays (Free: 5/5 | Pro: 15/15)
- Refine milestone popups + badges  
âœ… Clear overlays, no console errors

---

### ğŸš€ Day 7 â€” Ship Chargeable MVP
- Offline-safe fallback logic
- Stripe â†’ Supabase â†’ extension sync confirmed
- Deploy server (Railway / Render)
- Zip and publish extension build  
âœ… MVP ready for real users + Stripe payments

---

## ğŸ§© Architecture Principles

### Extension (`/extension`)
- **background/background.js:** Core logic, counters, backend communication  
- **content/content.js:** DOM detection + overlays only  
- **lib/constants.js:** Thresholds and limits  
- **lib/state.js:** Chrome storage and reset logic  
- **lib/rules.js:** Pure logic (no APIs or DOM)

### Backend (`/server`)
- **src/index.ts:** Express entrypoint  
- **src/supabase.ts:** Supabase client  
- **src/verify.ts:** Returns `{ plan }`  
- **src/stripeWebhook.ts:** Stripe â†’ Supabase sync  
- **src/aiClassify.ts:** OpenAI call + caching  

### Supabase Tables
- `users (id, email, plan)`
- `ai_logs (user_id, text, category, confidence, created_at)`
- `subscriptions (optional, for Stripe linking)`
- `preferences (optional, user goals)`

---

## ğŸ”Œ API Endpoints
| Endpoint | Purpose |
|-----------|----------|
| `GET /license/verify?email=` | Returns `{ plan }` |
| `POST /ai/classify` | Classifies text with OpenAI |
| `POST /stripe/create-checkout` | Returns hosted checkout URL |
| `POST /webhook/stripe` | Updates plan after payment |

---

## ğŸ§± Core Development Rules
- **One MV3 listener only** â€” return `true` for async  
- **rules.js** stays pure (no APIs or DOM)
- **background.js** manages counters + API calls
- **content.js** enforces UI only
- Always handle backend/AI failure safely (`category:"neutral"`)
- Use ES modules and debounced navigation detection (150ms)
- Reset counters/allowances daily (`ft_last_reset_key`)
- Cross-tab sync via `chrome.storage.onChanged`

---

## ğŸ§  AI Classification Logic
- **Endpoint:** `/ai/classify`
- **Input:** `{ user_id, text, context }`
- **Output:** `{ category: "productive"|"neutral"|"distracting", confidence }`
- **Caching:** 24h/user/text
- **Fallback:** Returns neutral + logs on failure  
â€œDistractingâ€ triggers block unless within daily allowance.

---

## âœ… MVP Launch Criteria
- **Free:** Shorts blocked, 5 searches/day, reminders working  
- **Pro:** AI filtering live, 1 daily allowance, functioning Stripe  
- **Backend:** Supabase + Stripe + OpenAI live, caching stable  
- **Quality:** No console errors, tabs sync, safe fallbacks  

---

## ğŸš€ Post-MVP Roadmap (AI & Insights)
- **Goal-linked AI:** Users set weekly goals â†’ AI adapts recommendations  
- **Dashboard:** Shows viewing patterns, productive/distracting ratios  
- **Reflection nudges:** â€œYou spent 80% of time learning â€” what will you apply?â€  
- **Multi-site support:** Block Reddit/TikTok for Pro+  
- **AI Mentor Mode:** Personalized feedback loop & goal refinement  
*(Phased rollout â€” once MVP stable and users onboarded)*

---